# コーディングガイドライン

## 概要
このドキュメントは、pycodemetricsプロジェクトの開発におけるアーキテクチャ設計とコード品質に関する包括的なガイドラインを提供します。
保守性、テスタビリティ、拡張性を重視した設計と、読みやすく信頼性の高いコードを書くための指針として使用してください。

## 1. アーキテクチャ設計

### 1.1 レイヤー構造
プロジェクトは以下の4つのレイヤーで構成し、各レイヤーの責務を明確に分離すること：

1. **プレゼンテーション層** (`cli/`)
   - コマンドラインインターフェースのためのレイヤー。コマンドラインからの入力の受付や、コマンドラインでの結果表示を責務とする。
   - ユーザー入力の型や明らかな間違いを早期にユーザーに返却するためのバリデーションを行う
   - 結果の表示形式を制御する
   - エラーメッセージを整形する
   - コマンドのリターンコードを制御する

2. **アプリケーション層** (`services/`)
   - インターフェースによらずに、ユースケースや全体のコントロールを行うレイヤー。

3. **ドメイン層** (`metrics/`)
   - メトリクス計算のコアロジックを実装するレイヤー。
   - ドメインモデルを定義すること
   - ビジネスルールを実装すること
   - ドメイン固有のバリデーションを行うこと

4. **ユーティリティ** (`util/`)
   - ユーティリティ関数を提供する

5. **Gitコマンドのインターフェース** (`gitclient`)
    - gitコマンドをプログラム中から扱いやすくするためのインターフェースを提供する

6. **設定管理** (`config/`)
    - 設定を管理するための機能を提供する

### 1.2 依存関係の原則
- 依存関係は外側のレイヤーから内側のレイヤーに向かうようにすること
- 内側のレイヤーは外側のレイヤーに依存しないようにすること
- レイヤー間のインターフェースを明確に定義すること
- 循環依存を避けること

## コーディング規約
### 1. コードスタイル
- Googleスタイルのdocstringを使用
- 行の長さ制限: なし（E501は無視）
- インデント: スペース4つ
- 文字列: シングルクォートを使用

### 2. 型ヒント
- すべての関数とメソッドに型ヒントを付ける
- Pydanticモデルを使用する場合は、mypyプラグインを有効化
- 動的エイリアスには警告を有効化

### 3. 命名規則
- クラス名: PascalCase
- 関数・メソッド名: snake_case
- 変数名: snake_case
- 定数: UPPER_SNAKE_CASE

### 4. ドキュメンテーション
- すべてのモジュール、クラス、関数にdocstringを付ける
- Googleスタイルのdocstring形式を使用
- 複雑なロジックには適切なコメントを追加

### 5. エラー処理
- 適切な例外クラスを使用
- エラーメッセージは明確で具体的に
- 例外の伝播は慎重に

## 2. コード品質基準

### 2.1 命名規則
- 意図が明確な名前を使用すること
- 一貫性のある命名規則を適用すること
- 略語を避け、完全な単語を使用すること
- コンテキストに応じた適切な名前を選択すること

### 2.2 関数とメソッド
- 単一の責任を持つように実装すること
- 適切な長さ（20-30行程度）に保つこと
- 入力と出力を明確にすること
- 副作用を最小限に抑えること
- 適切なエラー処理を実装すること

### 2.3 クラス設計
- 単一責任の原則に従うこと
- 適切なカプセル化を実装すること
- インターフェースを明確に定義すること
- 不変性を活用すること（frozen=True）
- 適切な継承関係を設計すること

### 2.4 エラー処理
- 適切な例外階層を使用すること
- エラーメッセージを明確にすること
- エラーの伝播を適切に制御すること
- リカバリー戦略を実装すること
- ログ出力を適切に設定すること

## 3. 実装ガイドライン

### 3.1 モジュール分割
- 機能ごとにモジュールを分割すること
- 関連する機能は同じモジュールに配置すること
- モジュール間の依存関係を最小限にすること
- 適切な粒度で分割すること

### 3.2 データフロー
- Pydanticモデルを使用して型安全なパラメータを実装すること
- 不変なデータ構造を活用すること
- バリデーションルールを明確に定義すること
- データの変換と集約を明確にすること

### 3.3 テスト戦略
- ユニットテストを充実させること
- 統合テストを適切に配置すること
- テストカバレッジを維持すること
- テストデータを分離すること
- モックを適切に使用すること

## 4. 禁止事項
以下の行為を禁止します：

- レイヤー間の循環依存を作成すること
- 不適切な責務を混在させること
- 過度な結合を実装すること
- グローバル状態を使用すること
- 複雑すぎるロジックを実装すること
- コードを重複させること
- 未使用のコードを残すこと
- 不適切な例外処理を実装すること
- ハードコードされた値を使用すること
- 過度なネストを実装すること
- 長すぎる関数を作成すること
- 不適切な命名を使用すること

## 5. ベストプラクティス

### 5.1 コードの品質
- 型ヒントを徹底すること
- ドキュメンテーションを充実させること
- コードの一貫性を保つこと
- 定期的にリファクタリングを行うこと

### 5.2 パフォーマンス
- 適切なデータ構造を選択すること
- 効率的なアルゴリズムを使用すること
- リソース管理を最適化すること
- 並列処理を適切に実装すること

### 5.3 セキュリティ
- 入力値のバリデーションを適切に行うこと
- 機密情報を適切に管理すること
- セキュリティ脆弱性に対応すること
- アクセス制御を実装すること

## 6. レビュー基準
以下の観点でコードレビューを行うこと：

- アーキテクチャの一貫性を確認すること
- コードの可読性を評価すること
- パフォーマンスへの影響を確認すること
- セキュリティの考慮を確認すること
- テストの充実度を評価すること
- ドキュメントの品質を確認すること
