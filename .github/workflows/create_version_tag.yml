name: Create Tag and Test Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version number (e.g., 1.0.0)'
        required: true
      allow_tag_override:
        description: 'Allow overwriting existing tag'
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

jobs:
  create-tag-and-release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for all tags and branches

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install poetry toml

    - name: Update version in pyproject.toml
      id: update-version
      run: |
        python - <<EOF
        import toml
        import os

        with open('pyproject.toml', 'r') as f:
            data = toml.load(f)

        old_version = data['tool']['poetry']['version']
        new_version = '${{ github.event.inputs.version }}'

        if old_version != new_version:
            data['tool']['poetry']['version'] = new_version
            with open('pyproject.toml', 'w') as f:
                toml.dump(data, f)
            print("version_changed=true" >> $GITHUB_OUTPUT)
            print(f"Version updated from {old_version} to {new_version}")
        else:
            print("version_changed=false" >> $GITHUB_OUTPUT)
            print(f"Version unchanged: {old_version}")
        EOF

    - name: Commit and push changes
      if: steps.update-version.outputs.version_changed == 'true'
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add pyproject.toml
        git commit -m "Bump version to ${{ github.event.inputs.version }}"
        git push

    - name: Check if tag exists
      id: check-tag
      run: |
        if git rev-parse "v${{ github.event.inputs.version }}" >/dev/null 2>&1; then
          echo "tag_exists=true" >> $GITHUB_OUTPUT
        else
          echo "tag_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Create new tag
      if: steps.check-tag.outputs.tag_exists == 'false'
      run: |
        git tag v${{ github.event.inputs.version }}
        git push origin v${{ github.event.inputs.version }}

    - name: Override existing tag
      if: steps.check-tag.outputs.tag_exists == 'true' && github.event.inputs.allow_tag_override == 'true'
      run: |
        git tag -f v${{ github.event.inputs.version }}
        git push -f origin v${{ github.event.inputs.version }}

    - name: Fail if tag exists and override not allowed
      if: steps.check-tag.outputs.tag_exists == 'true' && github.event.inputs.allow_tag_override != 'true'
      run: |
        echo "Error: Tag v${{ github.event.inputs.version }} already exists and tag override is not allowed."
        exit 1

    - name: Build package
      run: poetry build

    - name: Upload to TestPyPI
      uses: pypa/gh-action-pypi-publish@v1.8.10
      with:
        user: __token__
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository_url: https://test.pypi.org/legacy/

    - name: Create or update release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if gh release view v${{ github.event.inputs.version }} &>/dev/null; then
          gh release delete v${{ github.event.inputs.version }} --yes
        fi
        gh release create v${{ github.event.inputs.version }} \
          --title "Release v${{ github.event.inputs.version }}" \
          --draft \
          --generate-notes \
          ./dist/*.whl \
          ./dist/*.tar.gz
